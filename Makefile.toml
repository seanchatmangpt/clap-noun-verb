[config]
skip_core_tasks = false
on_error_task = "notification"

[tasks.default]
dependencies = ["format-check", "clippy", "test"]
description = "Default task: format check, clippy, and tests"

# Formatting
[tasks.format]
command = "cargo"
args = ["fmt"]
description = "Format code with rustfmt"

[tasks.timeout-check]
description = "Verify timeout command exists before running tasks"
script = '''
which timeout || (echo "ERROR: timeout command not found" && exit 1)
'''

[tasks.format-check]
command = "cargo"
args = ["fmt", "--", "--check"]
description = "Check code formatting"

# Linting
[tasks.clippy]
command = "cargo"
args = ["clippy", "--", "-D", "warnings"]
description = "Run clippy linter"

[tasks.lint]
dependencies = ["timeout-check", "format-check", "clippy"]
description = "Run all linting checks"

# Testing
[tasks.test]
command = "cargo"
args = ["test", "--quiet"]
description = "Run tests (quiet mode)"

[tasks.test-lib-deterministic]
command = "cargo"
args = ["test", "--lib", "--quiet"]
env = { RUST_TEST_THREADS = "1" }
description = "Run library tests (deterministic, single-threaded, unfailable)"

[tasks.test-integration-isolated]
command = "cargo"
args = ["test", "--test", "*", "--quiet"]
env = { RUST_TEST_THREADS = "1" }
description = "Run integration tests (isolated, single-threaded, unfailable)"

[tasks.test-unfailable]
dependencies = ["test-lib-deterministic", "test-integration-isolated"]
description = "Run all tests with unfailable architecture (no timeouts needed)"

[tasks.test-all]
command = "cargo"
args = ["test", "--all-features"]
description = "Run all tests with all features"

[tasks.test-integration]
command = "cargo"
args = ["test", "--test", "integration_examples", "--", "--ignored"]
description = "Run integration tests for examples"

# Building
[tasks.build]
command = "cargo"
args = ["build"]
description = "Build the project"

[tasks.build-release]
command = "cargo"
args = ["build", "--release"]
description = "Build in release mode"

[tasks.build-examples]
command = "cargo"
args = ["build", "--examples"]
description = "Build all examples"

[tasks.check]
command = "cargo"
args = ["check"]
description = "Check code compilation"

[tasks.check-all]
command = "cargo"
args = ["check", "--all-features"]
description = "Check code with all features"

# Documentation
[tasks.doc]
description = "Build documentation as docs.rs would (complete verification)"
dependencies = ["build-examples"]
command = "cargo"
args = ["doc", "--no-deps", "--all-features"]
env = { RUSTDOCFLAGS = "-D warnings" }

[tasks.doc-open]
command = "cargo"
args = ["doc", "--open", "--no-deps"]
description = "Build and open documentation"

# Verification & CI
[tasks.verify]
description = "Verify code quality: format, clippy, and tests"
dependencies = ["format-check", "clippy", "test-timeout"]

[tasks.ci]
dependencies = [
    "format-check",
    "clippy",
    "test-unfailable",
    "build-examples",
    "check-all",
]
description = "Run all CI checks (unfailable test architecture)"

# Release
[tasks.release-check]
description = "Run all checks before release"
dependencies = [
    "format-check",
    "clippy",
    "test-all",
    "build-release",
    "build-examples",
    "check-all",
    "doc",
]

# Publishing
[tasks.publish-dry-run-macros]
description = "Dry-run publish macros crate to crates.io"
command = "cargo"
args = [
    "publish",
    "--dry-run",
    "--manifest-path",
    "clap-noun-verb-macros/Cargo.toml",
]

[tasks.publish-macros]
description = "Publish macros crate to crates.io"
command = "cargo"
args = ["publish", "--manifest-path", "clap-noun-verb-macros/Cargo.toml"]

[tasks.publish-dry-run]
description = "Dry-run publish main crate to crates.io"
command = "cargo"
args = ["publish", "--dry-run"]

[tasks.publish]
description = "Publish main crate to crates.io (after macros)"
dependencies = ["publish-macros"]
command = "cargo"
args = ["publish"]

[tasks.publish-all]
description = "Complete publish workflow: checks + publish both crates"
dependencies = [
    "release-check",
    "publish-dry-run-macros",
    "publish-macros",
    "publish-dry-run",
    "publish",
]

[tasks.verify-publish]
description = "Verify publication by searching crates.io"
command = "cargo"
args = ["search", "clap-noun-verb"]

# Utilities
[tasks.clean]
command = "cargo"
args = ["clean"]
description = "Clean build artifacts"

[tasks.audit]
command = "cargo"
args = ["audit"]
description = "Run security audit"

[tasks.notification]
script = '''
echo "Task failed - check output above"
'''
description = "Error notification task"

# =============================================================================
# FRONTIER FEATURE TESTING - Phase 1 Architecture Validation
# =============================================================================

[tasks.test-frontier-all]
command = "cargo"
args = ["test", "--features", "frontier-all", "--quiet"]
description = "Test with all frontier features enabled"

[tasks.test-frontier-minimal]
command = "cargo"
args = ["test", "--no-default-features", "--quiet"]
description = "Test with minimal features (no frontiers)"

[tasks.test-frontier-semantic]
command = "cargo"
args = ["test", "--features", "frontier-semantic", "--quiet"]
description = "Test frontier-semantic meta-feature"

[tasks.test-frontier-intelligence]
command = "cargo"
args = ["test", "--features", "frontier-intelligence", "--quiet"]
description = "Test frontier-intelligence meta-feature"

[tasks.test-frontier-quality]
command = "cargo"
args = ["test", "--features", "frontier-quality", "--quiet"]
description = "Test frontier-quality meta-feature"

[tasks.check-frontier-all]
command = "cargo"
args = ["check", "--features", "frontier-all"]
description = "Check compilation with all frontier features"

[tasks.check-frontier-minimal]
command = "cargo"
args = ["check", "--no-default-features"]
description = "Check compilation with no features"

[tasks.build-frontier-all]
command = "cargo"
args = ["build", "--features", "frontier-all"]
description = "Build with all frontier features"

[tasks.verify-frontier]
dependencies = [
    "check-frontier-minimal",
    "check-frontier-all",
    "test-frontier-all",
]
description = "Verify all frontier feature combinations compile and test"

# Benchmarking
[tasks.bench]
command = "cargo"
args = ["bench", "--all-features"]
description = "Run all benchmarks with criterion"

[tasks.bench-baseline]
command = "cargo"
args = ["bench", "--all-features", "--", "--save-baseline", "main"]
description = "Run benchmarks and save as baseline"

[tasks.bench-compare]
command = "cargo"
args = ["bench", "--all-features", "--", "--baseline", "main"]
description = "Run benchmarks and compare against baseline"

[tasks.slo-check]
description = "Verify all performance SLOs are met"
script = '''
echo "Running SLO validation benchmarks..."
cargo bench --all-features --bench discovery_engine_benchmarks 2>&1 | tee /tmp/slo_results.txt
cargo bench --all-features --bench agents_benchmarks 2>&1 | tee -a /tmp/slo_results.txt

# Check for SLO violations in output
if grep -q "SLO:" /tmp/slo_results.txt; then
    echo "âœ… SLO checks completed - see output above"
else
    echo "âš ï¸  No SLO assertions found"
fi
'''

[tasks.bench-phase1]
command = "cargo"
args = ["bench", "--bench", "phase1_foundation_benchmarks"]
description = "Run Phase 1 foundation benchmarks"

[tasks.bench-phase2]
command = "cargo"
args = ["bench", "--all-features", "--bench", "phase2_rdf_benchmarks"]
description = "Run Phase 2 RDF/Semantic benchmarks"

[tasks.bench-phase3]
command = "cargo"
args = ["bench", "--all-features", "--bench", "phase3_optimization_benchmarks"]
description = "Run Phase 3 Optimization & ML benchmarks"

[tasks.bench-phase4]
command = "cargo"
args = ["bench", "--all-features", "--bench", "phase4_advanced_benchmarks"]
description = "Run Phase 4 Advanced Features benchmarks"

[tasks.profile]
command = "cargo"
args = ["bench", "--all-features", "--", "--profile-time", "10"]
description = "Run benchmarks with profiling enabled"

# =============================================================================
# FRONTIER CI/CD TASKS - 5-Phase Development Infrastructure
# =============================================================================

[tasks.test-frontier]
command = "cargo"
args = ["test", "--all-features", "--quiet"]
description = "Run all tests with all frontier features enabled"

[tasks.test-frontier-matrix]
description = "Run tests across all 21 feature combinations (Tier 0-4)"
script_runner = "@shell"
script = '''
#!/bin/bash
set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  FRONTIER FEATURE MATRIX TEST - 21 Combinations"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Counter for progress
TOTAL=21
CURRENT=0

# Function to run tests with features
test_features() {
    CURRENT=$((CURRENT + 1))
    echo ""
    echo "[$CURRENT/$TOTAL] Testing: ${1:-baseline (no features)}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    if [ -z "$1" ]; then
        cargo test --quiet
    else
        cargo test --features "$1" --quiet
    fi

    if [ $? -eq 0 ]; then
        echo "âœ… PASS: ${1:-baseline}"
    else
        echo "âŒ FAIL: ${1:-baseline}"
        exit 1
    fi
}

# Tier 0: Baseline
test_features ""

# Tier 1: Individual features
test_features "meta-framework"
test_features "rdf-composition"
test_features "fractal-patterns"
test_features "discovery-engine"
test_features "federated-network"
test_features "learning-trajectories"
test_features "reflexive-testing"
test_features "economic-sim"
test_features "quantum-ready"

# Tier 2: Meta-features
test_features "frontier-semantic"
test_features "frontier-intelligence"
test_features "frontier-quality"

# Tier 3: Critical combinations
test_features "meta-framework,rdf-composition"
test_features "discovery-engine,learning-trajectories"
test_features "federated-network,rdf-composition"
test_features "economic-sim,learning-trajectories"
test_features "executable-specs"

# Tier 4: Extremes
test_features "frontier-all"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… ALL 21 FEATURE COMBINATIONS PASSED"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
'''

[tasks.coverage-report]
description = "Generate code coverage report with tarpaulin (requires cargo install cargo-tarpaulin)"
script_runner = "@shell"
script = '''
#!/bin/bash
set -e

echo "Generating code coverage report..."

# Check if tarpaulin is installed
if ! command -v cargo-tarpaulin &> /dev/null; then
    echo "Installing cargo-tarpaulin..."
    cargo install cargo-tarpaulin
fi

# Generate coverage
cargo tarpaulin --all-features --workspace \
    --out Html --out Xml \
    --output-dir coverage \
    --timeout 300 \
    --exclude-files 'tests/*' 'benches/*' 'examples/*'

echo "âœ… Coverage report generated in ./coverage/"
echo "Open ./coverage/index.html to view"

# Check coverage threshold
COVERAGE=$(grep -oP 'line-rate="\K[^"]+' coverage/cobertura.xml | head -1)
COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc)
echo "Coverage: ${COVERAGE_PCT}%"

if (( $(echo "$COVERAGE_PCT < 80" | bc -l) )); then
    echo "âš ï¸  WARNING: Coverage below 80% threshold"
else
    echo "âœ… Coverage meets 80% threshold"
fi
'''

[tasks.andon-check]
description = "Complete Andon Signal Protocol check (stop-the-line validation)"
dependencies = ["timeout-check"]
script_runner = "@shell"
script = '''
#!/bin/bash
set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸš¦ ANDON SIGNAL PROTOCOL - STOP THE LINE VALIDATION"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# CRITICAL: Stop the line if any check fails

echo ""
echo "ğŸš¦ ANDON CHECK 1: Compiler Errors"
cargo check 2>&1 | tee check.log
if grep -q "error\[E" check.log; then
    echo "âŒ ANDON RED: STOP THE LINE - Compiler errors detected"
    exit 1
fi
echo "âœ… ANDON GREEN: No compiler errors"

echo ""
echo "ğŸš¦ ANDON CHECK 2: Compiler Warnings"
if grep -q "warning:" check.log; then
    echo "âŒ ANDON YELLOW: STOP THE LINE - Compiler warnings detected"
    exit 1
fi
echo "âœ… ANDON GREEN: No compiler warnings"

echo ""
echo "ğŸš¦ ANDON CHECK 3: Test Failures"
cargo test --quiet 2>&1 | tee test.log
if grep -q "FAILED" test.log; then
    echo "âŒ ANDON RED: STOP THE LINE - Test failures detected"
    exit 1
fi
echo "âœ… ANDON GREEN: All tests pass"

echo ""
echo "ğŸš¦ ANDON CHECK 4: Clippy Warnings"
cargo clippy -- -D warnings
echo "âœ… ANDON GREEN: No clippy warnings"

echo ""
echo "ğŸš¦ ANDON CHECK 5: Formatting"
cargo fmt -- --check
echo "âœ… ANDON GREEN: Code properly formatted"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… ALL ANDON SIGNALS GREEN - PROCEED WITH CONFIDENCE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
'''

[tasks.security-scan]
description = "Comprehensive security scanning (audit, deny, outdated)"
script_runner = "@shell"
script = '''
#!/bin/bash
set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  SECURITY SCANNING"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Install tools if needed
command -v cargo-audit &> /dev/null || cargo install cargo-audit
command -v cargo-deny &> /dev/null || cargo install cargo-deny
command -v cargo-outdated &> /dev/null || cargo install cargo-outdated

echo ""
echo "ğŸ”’ Security Audit (cargo-audit)..."
cargo audit
echo "âœ… No known vulnerabilities"

echo ""
echo "ğŸ”’ License & Advisory Check (cargo-deny)..."
cargo deny check licenses
cargo deny check advisories
cargo deny check bans
echo "âœ… License and security checks passed"

echo ""
echo "ğŸ”’ Dependency Freshness (cargo-outdated)..."
cargo outdated --root-deps-only
echo "âœ… Dependency check complete"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… SECURITY SCAN COMPLETE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
'''

[tasks.pre-commit-frontier]
dependencies = ["format", "andon-check", "test-frontier"]
description = "Pre-commit checks with frontier features: format, Andon signals, all tests"

[tasks.release-validate]
dependencies = [
    "andon-check",
    "test-frontier-matrix",
    "coverage-report",
    "bench-compare",
    "slo-check",
    "security-scan",
    "build-release",
    "doc",
]
description = "Comprehensive release validation (all checks)"
