name: Projection Verification

on:
  pull_request:
    paths:
      - 'src/**/*.rs'
      - 'clap-noun-verb-macros/src/**/*.rs'
  push:
    branches:
      - main
      - claude/**

jobs:
  verify-no-hand-edits:
    name: Verify generated code integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Check for suspicious hand-edit markers
        run: |
          # Look for common markers of hand-edited code in generated sections
          # This is a heuristic check; not perfect but catches obvious issues

          echo "Scanning for hand-edit markers in src/..."

          # Files that should NEVER have direct hand-edits
          # (These would normally be generated by ggen in production)
          SUSPICIOUS_PATTERNS=(
            "TODO.*generated"
            "FIXME.*generated"
            "XXX.*hand.?edit"
            "HACK.*code.?gen"
          )

          VIOLATIONS=0
          for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
            if grep -r --include="*.rs" "$pattern" src/; then
              echo "WARNING: Found potential hand-edit marker: $pattern"
              ((VIOLATIONS++))
            fi
          done

          if [ $VIOLATIONS -gt 0 ]; then
            echo "Found $VIOLATIONS potential violations of projection model"
            echo "Generated code should not contain hand-edit TODOs"
            exit 1
          fi

          echo "✓ No suspicious hand-edit markers found"

      - name: Verify macro-generated code consistency
        run: |
          echo "Verifying attribute macro consistency..."

          # Check that #[noun] and #[verb] attributes are properly applied
          # Look for any functions that implement CNV patterns but lack annotations

          if grep -r "impl.*Noun" src/ --include="*.rs" | grep -v "#\[noun\]"; then
            echo "WARNING: Found Noun impls without #[noun] attribute"
            # This is informational; not a hard error (backward compat)
          fi

          if grep -r "impl.*Verb" src/ --include="*.rs" | grep -v "#\[verb\]"; then
            echo "WARNING: Found Verb impls without #[verb] attribute"
          fi

          echo "✓ Macro consistency check complete"

      - name: Document code generation policy
        run: |
          echo "Code-as-Projection Policy Check"
          echo "================================"
          echo ""
          echo "The following files are managed by projection engines (ggen):"
          echo "- These files should NOT be manually edited"
          echo "- Changes should be made to the ontology (Σ) instead"
          echo "- Re-generation will overwrite manual edits"
          echo ""
          echo "If you need to modify code in projection-managed files:"
          echo "1. Identify the corresponding ontology entry"
          echo "2. Edit the ontology (docs/schema/*.md or src/autonomic/schema.rs)"
          echo "3. Run: cargo run --bin ggen regenerate"
          echo "4. Commit the regenerated files"
          echo ""
          echo "This ensures A = μ(O) remains valid."

  check-determinism:
    name: Verify deterministic build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build (first time)
        run: cargo build --release 2>&1 | tee build1.log

      - name: Clean artifacts
        run: cargo clean

      - name: Build (second time)
        run: cargo build --release 2>&1 | tee build2.log

      - name: Compare builds
        run: |
          echo "Checking deterministic compilation..."

          # In ideal world, binaries would be byte-identical
          # This is checking compilation logs for consistency

          if diff -u build1.log build2.log; then
            echo "✓ Compilation output is identical (deterministic)"
          else
            echo "Note: Compilation logs differ (expected for timestamps)"
            echo "But this suggests potential non-determinism in build process"
          fi
