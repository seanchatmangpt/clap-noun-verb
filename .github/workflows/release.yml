name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Validation - ensure code quality before publishing
  validate:
    name: Validate Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2
        with:
          key: validate-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-features --workspace -- -D warnings

      - name: Build all features
        run: cargo build --all-features --workspace --release

      - name: Run tests
        run: cargo test --all-features --workspace

      - name: Build documentation
        run: cargo doc --all-features --workspace --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  # MSRV check - ensure minimum supported Rust version works
  msrv-check:
    name: MSRV Check (1.74)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@1.74.0

      - uses: Swatinem/rust-cache@v2
        with:
          key: msrv-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build with MSRV
        run: cargo build --all-features --workspace

      - name: Test with MSRV
        run: cargo test --all-features --workspace

  # Security check - audit dependencies before release
  security-check:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: security-release-${{ hashFiles('**/Cargo.lock') }}

      - uses: taiki-e/install-action@cargo-audit

      - name: Run cargo-audit
        run: cargo audit --deny warnings

  # License check - ensure legal compliance
  license-check:
    name: License Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: license-release-${{ hashFiles('**/Cargo.lock') }}

      - uses: taiki-e/install-action@cargo-deny

      - name: Check licenses
        run: cargo deny check licenses --deny warnings

      - name: Check advisories
        run: cargo deny check advisories --deny warnings

      - name: Check bans
        run: cargo deny check bans --deny warnings

  # Publish - only runs if all quality gates pass
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs:
      - validate
      - msrv-check
      - security-check
      - license-check
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: publish-${{ hashFiles('**/Cargo.lock') }}

      - name: Publish clap-noun-verb-macros to crates.io
        run: cargo publish -p clap-noun-verb-macros --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        working-directory: clap-noun-verb-macros

      - name: Wait for macros crate to be available
        run: |
          for i in {1..30}; do
            if cargo search clap-noun-verb-macros --limit 1 | grep -q "clap_noun_verb_macros"; then
              echo "✓ Macros crate published successfully"
              exit 0
            fi
            echo "Waiting for macros crate to be indexed... ($i/30)"
            sleep 2
          done
          echo "✗ Macros crate not available after timeout"
          exit 1

      - name: Publish clap-noun-verb to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Success
        run: echo "✓ Release v${{ github.ref_name }} published successfully"
